import React, { Component, useEffect, useState } from "react";
import { compose } from "recompose";
import {
  withScriptjs,
  withGoogleMap,
  GoogleMap,
  Marker,
  InfoWindow
} from "react-google-maps";
import { GMapsSpan, OESpan } from "./Map.style";
import store from "../../Store/Store";
import { callApiFetch } from "../../common/global";
import { measureDistance } from "../../common/global";
import Keys from "../../keys";

const MapWithMarker = compose(
  withScriptjs,
  withGoogleMap
)(props => {
  const { useGlobalState } = store;
  const [adapter] = useGlobalState("adapter");
  const [loading, setLoading] = useState(false);
  const [gMapsElevation, setGMapsElevation] = useGlobalState("gmapsCoordinates");
  const [trialCoords] = useGlobalState("trialCoords");
  const image =
    "https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png";

  const icon = {
    url:
      "https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png",
    size: { width: 140, height: 160 },
    anchor: { x: 15, y: 50 },
    scaledSize: { width: 30, height: 50 }
  };

  const elevationResults = [];
  const generateApiParameter = (trialCoords) => {
    let str = "";
    for(let i = 0; i < trialCoords.length ; i++) {
      if(i !== trialCoords.length -1) {
        str = `${str}${trialCoords[i].lat},${trialCoords[i].lng}%7C`;
      }
      else {
        str = `${str}${trialCoords[i].lat},${trialCoords[i].lng}`;
      }
    }
      return str;
    }

     const myResults = [{"lat": 49.685178144109, "lng": 19.029745261382, "e": 1252.0, "d": 0.0}, {"lat": 49.6872124591308, "lng": 19.0269962103982, "e": 1194.0, "d": 0.30056195726195273}, {"lat": 49.6892467090782, "lng": 19.0242469293256, "e": 1072.0, "d": 0.6011239145204607}, {"lat": 49.691280893941, "lng": 19.0214974181356, "e": 956.0, "d": 0.9016858717750964}, {"lat": 49.6933150137092, "lng": 19.0187476767997, "e": 817.0, "d": 1.2022478290404908}, {"lat": 49.6953490683726, "lng": 19.0159977052896, "e": 831.0, "d": 1.5028097863010308}, {"lat": 49.697383057921, "lng": 19.0132475035767, "e": 811.0, "d": 1.803371743559397}, {"lat": 49.6994169823444, "lng": 19.0104970716327, "e": 746.0, "d": 2.1039337008189607}, {"lat": 49.7014508416325, "lng": 19.0077464094289, "e": 620.0, "d": 2.40449565807616}, {"lat": 49.7034846357753, "lng": 19.004995516937, "e": 560.0, "d": 2.7050576153357744}, {"lat": 49.7055183647626, "lng": 19.0022443941284, "e": 567.0, "d": 3.0056195725986665}, {"lat": 49.7075520285843, "lng": 18.9994930409747, "e": 699.0, "d": 3.30618152986459}, {"lat": 49.7095856272301, "lng": 18.9967414574475, "e": 742.0, "d": 3.6067434871159065}, {"lat": 49.71161916069, "lng": 18.9939896435181, "e": 797.0, "d": 3.9073054443773736}, {"lat": 49.7136526289539, "lng": 18.9912375991582, "e": 724.0, "d": 4.207867401642549}, {"lat": 49.7156860320115, "lng": 18.9884853243393, "e": 656.0, "d": 4.5084293588990505}, {"lat": 49.7177193698527, "lng": 18.9857328190327, "e": 717.0, "d": 4.808991316163486}, {"lat": 49.7197526424673, "lng": 18.9829800832102, "e": 596.0, "d": 5.1095532734158295}, {"lat": 49.7217858498453, "lng": 18.9802271168431, "e": 635.0, "d": 5.4101152306804865}, {"lat": 49.7238189919764, "lng": 18.977473919903, "e": 613.0, "d": 5.710677187939584}, {"lat": 49.7258520688505, "lng": 18.9747204923614, "e": 668.0, "d": 6.01123914519895}, {"lat": 49.7278850804574, "lng": 18.9719668341897, "e": 711.0, "d": 6.311801102459149}, {"lat": 49.7299180267869, "lng": 18.9692129453595, "e": 763.0, "d": 6.612363059712709}, {"lat": 49.731950907829, "lng": 18.9664588258422, "e": 758.0, "d": 6.9129250169781}, {"lat": 49.7339837235734, "lng": 18.9637044756093, "e": 710.0, "d": 7.213486974241856}, {"lat": 49.7360164740099, "lng": 18.9609498946324, "e": 700.0, "d": 7.514048931497631}, {"lat": 49.7380491591284, "lng": 18.9581950828829, "e": 816.0, "d": 7.814610888754377}, {"lat": 49.7400817789188, "lng": 18.9554400403323, "e": 913.0, "d": 8.11517284601694}, {"lat": 49.7421143333708, "lng": 18.952684766952, "e": 922.0, "d": 8.415734803279177}, {"lat": 49.7441468224742, "lng": 18.9499292627135, "e": 863.0, "d": 8.716296760537073}, {"lat": 49.746179246219, "lng": 18.9471735275884, "e": 898.0, "d": 9.01685871779976}, {"lat": 49.7482116045948, "lng": 18.944417561548, "e": 906.0, "d": 9.317420675057319}, {"lat": 49.7502438975916, "lng": 18.9416613645639, "e": 782.0, "d": 9.617982632317778}, {"lat": 49.7522761251992, "lng": 18.9389049366075, "e": 732.0, "d": 9.91854458958264}, {"lat": 49.7543082874073, "lng": 18.9361482776503, "e": 645.0, "d": 10.219106546840543}, {"lat": 49.7563403842058, "lng": 18.9333913876638, "e": 708.0, "d": 10.5196685040968}, {"lat": 49.7583724155845, "lng": 18.9306342666193, "e": 668.0, "d": 10.820230461358484}, {"lat": 49.7604043815331, "lng": 18.9278769144883, "e": 653.0, "d": 11.120792418612934}, {"lat": 49.7624362820417, "lng": 18.9251193312424, "e": 686.0, "d": 11.421354375878035}, {"lat": 49.7644681170998, "lng": 18.9223615168529, "e": 684.0, "d": 11.72191633313523}, {"lat": 49.7664998866974, "lng": 18.9196034712913, "e": 669.0, "d": 12.022478290398299}, {"lat": 49.7685315908242, "lng": 18.9168451945291, "e": 573.0, "d": 12.323040247654827}, {"lat": 49.77056322947, "lng": 18.9140866865376, "e": 543.0, "d": 12.623602204912162}, {"lat": 49.7725948026247, "lng": 18.9113279472884, "e": 528.0, "d": 12.92416416217165}, {"lat": 49.7746263102781, "lng": 18.9085689767528, "e": 464.0, "d": 13.224726119438634}, {"lat": 49.7766577524198, "lng": 18.9058097749023, "e": 431.0, "d": 13.52528807669433}, {"lat": 49.7786891290398, "lng": 18.9030503417084, "e": 418.0, "d": 13.82585003395166}, {"lat": 49.7807204401278, "lng": 18.9002906771424, "e": 413.0, "d": 14.126411991209872}, {"lat": 49.7827516856737, "lng": 18.8975307811757, "e": 408.0, "d": 14.426973948478928}, {"lat": 49.7847828656671, "lng": 18.8947706537799, "e": 396.0, "d": 14.727535905733406}, {"lat": 49.786813980098, "lng": 18.8920102949264, "e": 387.0, "d": 15.028097862993713}, {"lat": 49.788845028956, "lng": 18.8892497045864, "e": 382.0, "d": 15.328659820253463}, {"lat": 49.790876012231, "lng": 18.8864888827316, "e": 386.0, "d": 15.6292217775096}, {"lat": 49.7929069299128, "lng": 18.8837278293332, "e": 378.0, "d": 15.929783734772569}, {"lat": 49.7949377819911, "lng": 18.8809665443627, "e": 375.0, "d": 16.230345692032056}, {"lat": 49.7969685684557, "lng": 18.8782050277915, "e": 355.0, "d": 16.53090764928998}, {"lat": 49.7989992892965, "lng": 18.875443279591, "e": 335.0, "d": 16.831469606556233}, {"lat": 49.8010299445031, "lng": 18.8726812997326, "e": 341.0, "d": 17.13203156381652}, {"lat": 49.8030605340653, "lng": 18.8699190881877, "e": 337.0, "d": 17.432593521073347}, {"lat": 49.805091057973, "lng": 18.8671566449278, "e": 326.0, "d": 17.73315547833239}, {"lat": 49.8071215162159, "lng": 18.8643939699241, "e": 304.0, "d": 18.033717435596348}, {"lat": 49.8091519087837, "lng": 18.8616310631482, "e": 300.0, "d": 18.334279392849954}, {"lat": 49.8111822356663, "lng": 18.8588679245713, "e": 300.0, "d": 18.634841350113188}, {"lat": 49.8132124968534, "lng": 18.8561045541649, "e": 323.0, "d": 18.935403307375648}, {"lat": 49.8152426923348, "lng": 18.8533409519004, "e": 341.0, "d": 19.23596526463822}];


  useEffect(() => {
     const myRes = [{"lat": 49.685178144109, "lng": 19.029745261382, "e": 1252.0, "d": 0.0}, {"lat": 49.6872124591308, "lng": 19.0269962103982, "e": 1194.0, "d": 0.30056195726195273}, {"lat": 49.6892467090782, "lng": 19.0242469293256, "e": 1072.0, "d": 0.6011239145204607}, {"lat": 49.691280893941, "lng": 19.0214974181356, "e": 956.0, "d": 0.9016858717750964}, {"lat": 49.6933150137092, "lng": 19.0187476767997, "e": 817.0, "d": 1.2022478290404908}, {"lat": 49.6953490683726, "lng": 19.0159977052896, "e": 831.0, "d": 1.5028097863010308}, {"lat": 49.697383057921, "lng": 19.0132475035767, "e": 811.0, "d": 1.803371743559397}, {"lat": 49.6994169823444, "lng": 19.0104970716327, "e": 746.0, "d": 2.1039337008189607}, {"lat": 49.7014508416325, "lng": 19.0077464094289, "e": 620.0, "d": 2.40449565807616}, {"lat": 49.7034846357753, "lng": 19.004995516937, "e": 560.0, "d": 2.7050576153357744}, {"lat": 49.7055183647626, "lng": 19.0022443941284, "e": 567.0, "d": 3.0056195725986665}, {"lat": 49.7075520285843, "lng": 18.9994930409747, "e": 699.0, "d": 3.30618152986459}, {"lat": 49.7095856272301, "lng": 18.9967414574475, "e": 742.0, "d": 3.6067434871159065}, {"lat": 49.71161916069, "lng": 18.9939896435181, "e": 797.0, "d": 3.9073054443773736}, {"lat": 49.7136526289539, "lng": 18.9912375991582, "e": 724.0, "d": 4.207867401642549}, {"lat": 49.7156860320115, "lng": 18.9884853243393, "e": 656.0, "d": 4.5084293588990505}, {"lat": 49.7177193698527, "lng": 18.9857328190327, "e": 717.0, "d": 4.808991316163486}, {"lat": 49.7197526424673, "lng": 18.9829800832102, "e": 596.0, "d": 5.1095532734158295}, {"lat": 49.7217858498453, "lng": 18.9802271168431, "e": 635.0, "d": 5.4101152306804865}, {"lat": 49.7238189919764, "lng": 18.977473919903, "e": 613.0, "d": 5.710677187939584}, {"lat": 49.7258520688505, "lng": 18.9747204923614, "e": 668.0, "d": 6.01123914519895}, {"lat": 49.7278850804574, "lng": 18.9719668341897, "e": 711.0, "d": 6.311801102459149}, {"lat": 49.7299180267869, "lng": 18.9692129453595, "e": 763.0, "d": 6.612363059712709}, {"lat": 49.731950907829, "lng": 18.9664588258422, "e": 758.0, "d": 6.9129250169781}, {"lat": 49.7339837235734, "lng": 18.9637044756093, "e": 710.0, "d": 7.213486974241856}, {"lat": 49.7360164740099, "lng": 18.9609498946324, "e": 700.0, "d": 7.514048931497631}, {"lat": 49.7380491591284, "lng": 18.9581950828829, "e": 816.0, "d": 7.814610888754377}, {"lat": 49.7400817789188, "lng": 18.9554400403323, "e": 913.0, "d": 8.11517284601694}, {"lat": 49.7421143333708, "lng": 18.952684766952, "e": 922.0, "d": 8.415734803279177}, {"lat": 49.7441468224742, "lng": 18.9499292627135, "e": 863.0, "d": 8.716296760537073}, {"lat": 49.746179246219, "lng": 18.9471735275884, "e": 898.0, "d": 9.01685871779976}, {"lat": 49.7482116045948, "lng": 18.944417561548, "e": 906.0, "d": 9.317420675057319}, {"lat": 49.7502438975916, "lng": 18.9416613645639, "e": 782.0, "d": 9.617982632317778}, {"lat": 49.7522761251992, "lng": 18.9389049366075, "e": 732.0, "d": 9.91854458958264}, {"lat": 49.7543082874073, "lng": 18.9361482776503, "e": 645.0, "d": 10.219106546840543}, {"lat": 49.7563403842058, "lng": 18.9333913876638, "e": 708.0, "d": 10.5196685040968}, {"lat": 49.7583724155845, "lng": 18.9306342666193, "e": 668.0, "d": 10.820230461358484}, {"lat": 49.7604043815331, "lng": 18.9278769144883, "e": 653.0, "d": 11.120792418612934}, {"lat": 49.7624362820417, "lng": 18.9251193312424, "e": 686.0, "d": 11.421354375878035}, {"lat": 49.7644681170998, "lng": 18.9223615168529, "e": 684.0, "d": 11.72191633313523}, {"lat": 49.7664998866974, "lng": 18.9196034712913, "e": 669.0, "d": 12.022478290398299}, {"lat": 49.7685315908242, "lng": 18.9168451945291, "e": 573.0, "d": 12.323040247654827}, {"lat": 49.77056322947, "lng": 18.9140866865376, "e": 543.0, "d": 12.623602204912162}, {"lat": 49.7725948026247, "lng": 18.9113279472884, "e": 528.0, "d": 12.92416416217165}, {"lat": 49.7746263102781, "lng": 18.9085689767528, "e": 464.0, "d": 13.224726119438634}, {"lat": 49.7766577524198, "lng": 18.9058097749023, "e": 431.0, "d": 13.52528807669433}, {"lat": 49.7786891290398, "lng": 18.9030503417084, "e": 418.0, "d": 13.82585003395166}, {"lat": 49.7807204401278, "lng": 18.9002906771424, "e": 413.0, "d": 14.126411991209872}, {"lat": 49.7827516856737, "lng": 18.8975307811757, "e": 408.0, "d": 14.426973948478928}, {"lat": 49.7847828656671, "lng": 18.8947706537799, "e": 396.0, "d": 14.727535905733406}, {"lat": 49.786813980098, "lng": 18.8920102949264, "e": 387.0, "d": 15.028097862993713}, {"lat": 49.788845028956, "lng": 18.8892497045864, "e": 382.0, "d": 15.328659820253463}, {"lat": 49.790876012231, "lng": 18.8864888827316, "e": 386.0, "d": 15.6292217775096}, {"lat": 49.7929069299128, "lng": 18.8837278293332, "e": 378.0, "d": 15.929783734772569}, {"lat": 49.7949377819911, "lng": 18.8809665443627, "e": 375.0, "d": 16.230345692032056}, {"lat": 49.7969685684557, "lng": 18.8782050277915, "e": 355.0, "d": 16.53090764928998}, {"lat": 49.7989992892965, "lng": 18.875443279591, "e": 335.0, "d": 16.831469606556233}, {"lat": 49.8010299445031, "lng": 18.8726812997326, "e": 341.0, "d": 17.13203156381652}, {"lat": 49.8030605340653, "lng": 18.8699190881877, "e": 337.0, "d": 17.432593521073347}, {"lat": 49.805091057973, "lng": 18.8671566449278, "e": 326.0, "d": 17.73315547833239}, {"lat": 49.8071215162159, "lng": 18.8643939699241, "e": 304.0, "d": 18.033717435596348}, {"lat": 49.8091519087837, "lng": 18.8616310631482, "e": 300.0, "d": 18.334279392849954}, {"lat": 49.8111822356663, "lng": 18.8588679245713, "e": 300.0, "d": 18.634841350113188}, {"lat": 49.8132124968534, "lng": 18.8561045541649, "e": 323.0, "d": 18.935403307375648}, {"lat": 49.8152426923348, "lng": 18.8533409519004, "e": 341.0, "d": 19.23596526463822}];


    const formattedCoords =  generateApiParameter(myRes);

    callApiFetch(`api/gmaps/all/${formattedCoords}`)
      .then(response =>  setGMapsElevation(response))
      .catch(err => console.log(err));
  }, []);

  return (
    <GoogleMap
      defaultZoom={11}
      defaultCenter={{ lat: +adapter.szerokosc, lng: +adapter.dlugosc }}
      defaultMapTypeId="terrain"
    >
      <Marker
        icon={icon}
        position={{ lat: +adapter.szerokosc, lng: +adapter.dlugosc }}
      />


      {myResults.map((marker, iterator) => {
        const onClick = props.onClick.bind(this, marker);
        return (
          <Marker
            key={Math.random()}
            onClick={onClick}
            position={{ lat: marker.lat, lng: marker.lng }}
          >

          </Marker>
        );
      })}
    </GoogleMap>
  );
});

export default class ShelterMap extends Component {
  constructor(props) {
    super(props);
    this.state = {
      shelters: [],
      selectedMarker: false
    };
  }

  handleClick = (marker, event) => {
    this.setState({ selectedMarker: marker });
  };
  render() {
    return (
      <MapWithMarker
        selectedMarker={this.state.selectedMarker}
        // markers={this.state.shelters}
        onClick={this.handleClick}
        googleMapURL={`https://maps.googleapis.com/maps/api/js?key=${Keys.mapsKey}&v=3.exp&libraries=geometry,drawing,places`}
        loadingElement={<div style={{ height: `100%` }} />}
        containerElement={<div style={{ height: `550px` }} />}
        mapElement={<div style={{ height: `100%` }} />}
      />
    );
  }
}
